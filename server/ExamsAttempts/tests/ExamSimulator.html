<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de ExÃ¡menes - WebSocket</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    .panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .panel h2 {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
      color: #333;
      font-size: 1.8em;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 0.95em;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
      transform: none;
    }
    .btn-danger { 
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .btn-danger:hover { 
      box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
    }
    .btn-success { 
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .btn-success:hover { 
      box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
    }
    .log {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }
    .log-entry {
      padding: 8px;
      margin: 3px 0;
      border-radius: 4px;
      border-left: 4px solid transparent;
    }
    .log-info { 
      background: #e3f2fd; 
      color: #1976d2; 
      border-left-color: #1976d2;
    }
    .log-success { 
      background: #e8f5e9; 
      color: #2e7d32; 
      border-left-color: #2e7d32;
    }
    .log-warning { 
      background: #fff3e0; 
      color: #f57c00; 
      border-left-color: #f57c00;
    }
    .log-error { 
      background: #ffebee; 
      color: #c62828; 
      border-left-color: #c62828;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      text-align: center;
      font-size: 1.1em;
    }
    .status-connected { 
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724; 
      border: 2px solid #28a745;
    }
    .status-disconnected { 
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24; 
      border: 2px solid #dc3545;
    }
    .status-blocked { 
      background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
      color: #856404; 
      border: 2px solid #ffc107;
    }
    .timer {
      font-size: 32px;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    .fraud-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    .fraud-buttons button {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      color: #2d3436;
      padding: 15px;
      font-size: 0.9em;
    }
    .fraud-buttons button:hover {
      background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
      color: white;
    }
    .alert-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }
    .alert-item {
      background: #fff3cd;
      border-left: 5px solid #ffc107;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .alert-item.blocked {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    .alert-item strong {
      display: block;
      margin-bottom: 8px;
      font-size: 1.1em;
    }
    .student-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .student-table th,
    .student-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    .student-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }
    .student-table tr:hover {
      background: #f5f5f5;
    }
    .section-title {
      font-size: 1.2em;
      font-weight: 600;
      margin-top: 25px;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .info-box p {
      margin: 5px 0;
      color: #1565c0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“ Simulador de ExÃ¡menes con WebSocket</h1>
    <p>Sistema de monitoreo y detecciÃ³n de fraude en tiempo real</p>
  </div>
  
  <div class="container">
    <!-- ========================================== -->
    <!-- PANEL ESTUDIANTE -->
    <!-- ========================================== -->
    <div class="panel">
      <h2>ğŸ‘¨â€ğŸ“ Panel del Estudiante</h2>
      
      <div id="studentStatus" class="status status-disconnected">
        âŒ Desconectado
      </div>

      <div id="timerDisplay" class="timer" style="display: none;">
        â±ï¸ 00:00
      </div>

      <!-- Formulario de inicio -->
      <div id="studentForm">
        <div class="form-group">
          <label>ğŸ”¢ CÃ³digo del Examen:</label>
          <input type="text" id="examCode" value="W71kN9wX" placeholder="Ingresa el cÃ³digo">
        </div>
        <div class="form-group">
          <label>ğŸ‘¤ Nombre Completo:</label>
          <input type="text" id="studentName" value="Juan PÃ©rez" placeholder="Tu nombre">
        </div>
        <div class="form-group">
          <label>ğŸ“§ Correo ElectrÃ³nico:</label>
          <input type="email" id="studentEmail" value="juan@test.com" placeholder="tu@email.com">
        </div>
        <div class="form-group">
          <label>ğŸ” ContraseÃ±a (si aplica):</label>
          <input type="password" id="examPassword" value="test123" placeholder="Dejar vacÃ­o si no aplica">
        </div>
        <button onclick="startExam()">ğŸš€ Iniciar Examen</button>
      </div>

      <!-- Controles durante el examen -->
      <div id="studentControls" style="display: none;">
        <div class="form-group">
          <label>ğŸ“ Simular Respuesta:</label>
          <input type="number" id="questionId" placeholder="ID Pregunta" value="1">
          <input type="text" id="answerText" placeholder="Respuesta" value="Mi respuesta de prueba">
          <button class="btn-success" onclick="submitAnswer()">ğŸ“¤ Enviar Respuesta</button>
        </div>

        <h3 class="section-title">âš ï¸ Simular Eventos de Fraude</h3>
        <div class="fraud-buttons">
          <button onclick="sendFraud('pantalla_completa_cerrada')">ğŸ–¥ï¸ Salir Pantalla Completa</button>
          <button onclick="sendFraud('foco_perdido')">ğŸ‘ï¸ Perder Foco</button>
          <button onclick="sendFraud('pestana_cambiada')">ğŸ”„ Cambiar PestaÃ±a</button>
          <button onclick="sendFraud('intento_copiar_pegar_imprimir')">ğŸ“‹ Copiar/Pegar</button>
          <button onclick="sendFraud('combinacion_teclas_prohibida')">âŒ¨ï¸ Teclas Prohibidas</button>
          <button onclick="sendFraud('manipulacion_codigo')">ğŸ› ï¸ Manipular CÃ³digo</button>
        </div>

        <button class="btn-success" onclick="finishExam()" style="margin-top: 20px;">
          âœ… Finalizar Examen
        </button>
        <button class="btn-danger" onclick="disconnectStudent()">
          ğŸ”Œ Desconectar
        </button>
      </div>

      <div class="log" id="studentLog"></div>
    </div>

    <!-- ========================================== -->
    <!-- PANEL PROFESOR -->
    <!-- ========================================== -->
    <div class="panel">
      <h2>ğŸ‘¨â€ğŸ« Panel del Profesor</h2>
      
      <div id="teacherStatus" class="status status-disconnected">
        âŒ Desconectado del Monitoreo
      </div>

      <div class="info-box">
        <p><strong>â„¹ï¸ InformaciÃ³n:</strong></p>
        <p>Debes estar autenticado (login) en el sistema para monitorear.</p>
        <p>La cookie de autenticaciÃ³n se enviarÃ¡ automÃ¡ticamente.</p>
      </div>

      <div class="form-group">
        <label>ğŸ¯ ID del Examen a Monitorear:</label>
        <input type="number" id="monitorExamId" value="3" placeholder="ID del examen">
        <button onclick="startMonitoring()">ğŸ‘€ Iniciar Monitoreo</button>
        <button class="btn-danger" onclick="stopMonitoring()">â¹ï¸ Detener</button>
      </div>

      <h3 class="section-title">ğŸ“Š Estudiantes Activos</h3>
      <div id="activeStudents" style="background: #f8f9fa; padding: 15px; border-radius: 8px; min-height: 60px;">
        <em style="color: #999;">No hay estudiantes activos</em>
      </div>

      <h3 class="section-title">ğŸš¨ Alertas de Fraude</h3>
      <div id="fraudAlerts" class="alert-list"></div>

      <div class="form-group" style="margin-top: 25px;">
        <label>ğŸ”“ Desbloquear Intento:</label>
        <input type="number" id="unlockAttemptId" placeholder="ID del Intento a desbloquear">
        <button class="btn-success" onclick="unlockAttempt()">ğŸ”“ Desbloquear Estudiante</button>
      </div>

      <div class="log" id="teacherLog"></div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3002';
    const SOCKET_URL = 'http://localhost:3002';

    let studentSocket = null;
    let teacherSocket = null;
    let currentAttemptId = null;
    let currentSessionId = null;
    let timerInterval = null;
    let students = new Map();

    // =============== UTILIDADES ===============
    function log(elementId, message, type = 'info') {
      const logDiv = document.getElementById(elementId);
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${time}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(elementId, text, connected) {
      const status = document.getElementById(elementId);
      status.textContent = text;
      status.className = connected ? 'status status-connected' : 'status status-disconnected';
    }

    // =============== ESTUDIANTE ===============
    async function startExam() {
      const code = document.getElementById('examCode').value;
      const name = document.getElementById('studentName').value;
      const email = document.getElementById('studentEmail').value;
      const password = document.getElementById('examPassword').value;

      log('studentLog', 'ğŸ”„ Iniciando examen...', 'info');

      try {
        const response = await fetch(`${API_URL}/api/exam/attempt/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            codigo_examen: code,
            nombre_estudiante: name,
            correo_estudiante: email,
            contrasena: password || undefined
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message);
        }

        const data = await response.json();
        currentAttemptId = data.attempt.id;
        currentSessionId = data.examInProgress.id_sesion;

        log('studentLog', `âœ… Intento creado: ID ${currentAttemptId}`, 'success');
        log('studentLog', `ğŸ”‘ CÃ³digo acceso: ${data.examInProgress.codigo_acceso}`, 'info');
        log('studentLog', `ğŸ†” Session ID: ${currentSessionId}`, 'info');

        connectStudentSocket();

        document.getElementById('studentForm').style.display = 'none';
        document.getElementById('studentControls').style.display = 'block';

        if (data.examInProgress.fecha_expiracion) {
          startTimer(new Date(data.examInProgress.fecha_expiracion));
        }

      } catch (error) {
        log('studentLog', `âŒ Error: ${error.message}`, 'error');
      }
    }

    function connectStudentSocket() {
      studentSocket = io(SOCKET_URL, {
        withCredentials: true,
        transports: ['websocket', 'polling']
      });

      studentSocket.on('connect', () => {
        log('studentLog', `ğŸ”Œ WebSocket conectado: ${studentSocket.id}`, 'success');
        updateStatus('studentStatus', 'âœ… Conectado', true);

        studentSocket.emit('join_attempt', {
          attemptId: currentAttemptId,
          sessionId: currentSessionId
        });
      });

      studentSocket.on('joined_attempt', (data) => {
        log('studentLog', `âœ… Unido al intento ${data.attemptId}`, 'success');
      });

      studentSocket.on('fraud_detected', (data) => {
        log('studentLog', `âš ï¸ FRAUDE DETECTADO: ${data.tipo_evento}`, 'warning');
      });

      studentSocket.on('attempt_blocked', (data) => {
        log('studentLog', `ğŸš« EXAMEN BLOQUEADO: ${data.message}`, 'error');
        updateStatus('studentStatus', 'ğŸš« BLOQUEADO POR FRAUDE', false);
        document.getElementById('studentStatus').classList.add('status-blocked');
      });

      studentSocket.on('attempt_unlocked', (data) => {
        log('studentLog', `ğŸ”“ EXAMEN DESBLOQUEADO: ${data.message}`, 'success');
        updateStatus('studentStatus', 'âœ… Conectado', true);
      });

      studentSocket.on('attempt_finished', (data) => {
        log('studentLog', `âœ… EXAMEN FINALIZADO - Puntaje: ${data.puntaje}/${data.puntajeMaximo}`, 'success');
        stopTimer();
      });

      studentSocket.on('time_expired', (data) => {
        log('studentLog', `â° TIEMPO EXPIRADO: ${data.message}`, 'error');
        stopTimer();
      });

      studentSocket.on('answer_saved', (data) => {
        log('studentLog', `ğŸ’¾ Respuesta guardada automÃ¡ticamente`, 'success');
      });

      studentSocket.on('disconnect', () => {
        log('studentLog', 'ğŸ”Œ Desconectado del servidor', 'warning');
        updateStatus('studentStatus', 'âŒ Desconectado', false);
      });

      studentSocket.on('error', (data) => {
        log('studentLog', `âŒ Error: ${data.message}`, 'error');
      });
    }

    async function submitAnswer() {
      const questionId = document.getElementById('questionId').value;
      const answerText = document.getElementById('answerText').value;

      try {
        const response = await fetch(`${API_URL}/api/exam/answer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pregunta_id: parseInt(questionId),
            respuesta: answerText,
            fecha_respuesta: new Date(),
            intento_id: currentAttemptId
          })
        });

        if (!response.ok) throw new Error('Error al enviar respuesta');

        log('studentLog', `âœ… Respuesta enviada a pregunta ${questionId}`, 'success');
      } catch (error) {
        log('studentLog', `âŒ Error: ${error.message}`, 'error');
      }
    }

    async function sendFraud(eventType) {
      try {
        const response = await fetch(`${API_URL}/api/exam/event`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tipo_evento: eventType,
            fecha_envio: new Date(),
            intento_id: currentAttemptId
          })
        });

        if (!response.ok) throw new Error('Error al enviar evento');

        log('studentLog', `âš ï¸ Evento de fraude enviado: ${eventType}`, 'warning');
      } catch (error) {
        log('studentLog', `âŒ Error: ${error.message}`, 'error');
      }
    }

    async function finishExam() {
      try {
        const response = await fetch(`${API_URL}/api/exam/attempt/${currentAttemptId}/finish`, {
          method: 'POST'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message);
        }

        log('studentLog', 'âœ… Examen finalizado correctamente', 'success');
        stopTimer();
      } catch (error) {
        log('studentLog', `âŒ ${error.message}`, 'error');
      }
    }

    function disconnectStudent() {
      if (studentSocket) {
        studentSocket.disconnect();
        stopTimer();
        document.getElementById('studentForm').style.display = 'block';
        document.getElementById('studentControls').style.display = 'none';
        currentAttemptId = null;
        currentSessionId = null;
      }
    }

    function startTimer(expirationDate) {
      document.getElementById('timerDisplay').style.display = 'block';
      
      timerInterval = setInterval(() => {
        const now = new Date();
        const diff = expirationDate - now;

        if (diff <= 0) {
          stopTimer();
          document.getElementById('timerDisplay').textContent = 'â° TIEMPO EXPIRADO';
          document.getElementById('timerDisplay').style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
          return;
        }

        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        document.getElementById('timerDisplay').textContent = 
          `â±ï¸ ${minutes}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      document.getElementById('timerDisplay').style.display = 'none';
    }

    // =============== PROFESOR ===============
    function startMonitoring() {
      const examId = document.getElementById('monitorExamId').value;

      log('teacherLog', 'ğŸ”„ Conectando al servidor...', 'info');

      teacherSocket = io(SOCKET_URL, {
        withCredentials: true,
        transports: ['websocket', 'polling']
      });

      teacherSocket.on('connect', () => {
        log('teacherLog', `ğŸ”Œ Conectado: ${teacherSocket.id}`, 'success');
        updateStatus('teacherStatus', 'âœ… Conectado', true);

        teacherSocket.emit('join_exam_monitoring', parseInt(examId));
        log('teacherLog', `ğŸ“¡ Solicitando monitoreo del examen ${examId}...`, 'info');
      });

      teacherSocket.on('monitoring_started', (data) => {
        log('teacherLog', `âœ… Monitoreando: ${data.examName}`, 'success');
        updateStatus('teacherStatus', `âœ… Monitoreando: ${data.examName}`, true);
      });

      teacherSocket.on('monitoring_error', (data) => {
        log('teacherLog', `âŒ Error: ${data.message}`, 'error');
        updateStatus('teacherStatus', `âŒ ${data.message}`, false);
      });

      teacherSocket.on('connect_error', (error) => {
        log('teacherLog', `âŒ Error de conexiÃ³n: ${error.message}`, 'error');
        updateStatus('teacherStatus', `âŒ ${error.message}`, false);
      });

      teacherSocket.on('student_started_exam', (data) => {
        log('teacherLog', `ğŸ“¢ Estudiante iniciÃ³ examen: ${data.estudiante.nombre}`, 'success');
        
        students.set(data.attemptId, {
          nombre: data.estudiante.nombre,
          correo: data.estudiante.correo,
          fecha_inicio: data.fecha_inicio,
          blocked: false
        });
        
        updateStudentList();
      });

      teacherSocket.on('fraud_alert', (data) => {
        log('teacherLog', `ğŸš¨ FRAUDE DETECTADO: ${data.tipo_evento} - Intento ${data.attemptId}`, 'warning');
        addFraudAlert(data);
        
        if (data.blocked) {
          const student = students.get(data.attemptId);
          if (student) {
            student.blocked = true;
            updateStudentList();
          }
        }
      });

      teacherSocket.on('student_finished_exam', (data) => {
        log('teacherLog', `âœ… Estudiante finalizÃ³ examen - Puntaje: ${data.puntaje}`, 'success');
        students.delete(data.attemptId);
        updateStudentList();
      });

      teacherSocket.on('disconnect', () => {
        log('teacherLog', 'ğŸ”Œ Desconectado del servidor', 'warning');
        updateStatus('teacherStatus', 'âŒ Desconectado', false);
      });
    }

    function stopMonitoring() {
      if (teacherSocket) {
        teacherSocket.disconnect();
        students.clear();
        updateStudentList();
        document.getElementById('fraudAlerts').innerHTML = '';
        log('teacherLog', 'â¹ï¸ Monitoreo detenido', 'info');
      }
    }

    function updateStudentList() {
      const div = document.getElementById('activeStudents');
      
      if (students.size === 0) {
        div.innerHTML = '<em style="color: #999;">No hay estudiantes activos</em>';
        return;
      }

      let html = '<table class="student-table">';
      html += '<thead><tr><th>ID Intento</th><th>Nombre</th><th>Correo</th><th>Estado</th></tr></thead>';
      html += '<tbody>';
      
      students.forEach((student, id) => {
        const status = student.blocked ? 'ğŸš« Bloqueado' : 'âœ… Activo';
        const color = student.blocked ? '#dc3545' : '#28a745';
        html += `<tr>
          <td><strong>${id}</strong></td>
          <td>${student.nombre || 'N/A'}</td>
          <td>${student.correo || 'N/A'}</td>
          <td style="color: ${color}; font-weight: bold;">${status}</td>
        </tr>`;
      });
      
      html += '</tbody></table>';
      div.innerHTML = html;
    }

    function addFraudAlert(data) {
      const div = document.getElementById('fraudAlerts');
      const alert = document.createElement('div');
      alert.className = data.blocked ? 'alert-item blocked' : 'alert-item';
      
      const time = new Date().toLocaleTimeString();
      alert.innerHTML = `
        <strong>${data.blocked ? 'ğŸ”’ INTENTO BLOQUEADO' : 'âš ï¸ ALERTA DE FRAUDE'}</strong>
        <p><strong>Hora:</strong> ${time}</p>
        <p><strong>Intento ID:</strong> ${data.attemptId}</p>
        <p><strong>Estudiante:</strong> ${data.estudiante?.nombre || 'N/A'} (${data.estudiante?.correo || 'N/A'})</p>
        <p><strong>Tipo de evento:</strong> ${data.tipo_evento}</p>
      `;
      
      div.insertBefore(alert, div.firstChild);

      // Limitar a 10 alertas mÃ¡ximo
      while (div.children.length > 10) {
        div.removeChild(div.lastChild);
      }
    }

    async function unlockAttempt() {
      const attemptId = document.getElementById('unlockAttemptId').value;

      if (!attemptId) {
        log('teacherLog', 'âŒ Debes ingresar un ID de intento', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/exam/attempt/${attemptId}/unlock`, {
          method: 'POST'
        });

        if (!response.ok) throw new Error('Error al desbloquear');

        log('teacherLog', `ğŸ”“ Intento ${attemptId} desbloqueado exitosamente`, 'success');
        
        // Actualizar en la lista local
        const student = students.get(parseInt(attemptId));
        if (student) {
          student.blocked = false;
          updateStudentList();
        }

      } catch (error) {
        log('teacherLog', `âŒ Error: ${error.message}`, 'error');
      }
    }

    // Limpiar al cerrar la pÃ¡gina
    window.addEventListener('beforeunload', () => {
      if (studentSocket) studentSocket.disconnect();
      if (teacherSocket) teacherSocket.disconnect();
    });
  </script>
</body>
</html>